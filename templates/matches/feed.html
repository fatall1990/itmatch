{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container">
    <div class="row">
        <!-- Левая колонка - фильтры -->
        <div class="col-lg-3 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Фильтры</h5>
                </div>
                <div class="card-body">
                    <form method="get" id="filter-form">
                        <div class="mb-3">
                            <label class="form-label">Роль</label>
                            <select name="role" class="form-select">
                                <option value="">Все роли</option>
                                <option value="frontend">Frontend Developer</option>
                                <option value="backend">Backend Developer</option>
                                <option value="fullstack">Fullstack Developer</option>
                                <option value="mobile">Mobile Developer</option>
                                <option value="devops">DevOps Engineer</option>
                                <option value="data">Data Scientist</option>
                                <option value="designer">UX/UI Designer</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Уровень</label>
                            <select name="level" class="form-select">
                                <option value="">Все уровни</option>
                                <option value="junior">Junior</option>
                                <option value="middle">Middle</option>
                                <option value="senior">Senior</option>
                                <option value="lead">Team Lead</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Формат работы</label>
                            <select name="work_mode" class="form-select">
                                <option value="">Любой</option>
                                <option value="remote">Удалённо</option>
                                <option value="office">Офис</option>
                                <option value="hybrid">Гибрид</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Технологии</label>
                            <input type="text" name="technologies" class="form-control" 
                                   placeholder="Python, React...">
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Применить</button>
                            <button type="button" class="btn btn-outline-secondary mt-2" 
                                    onclick="resetFilters()">Сбросить</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Статистика -->
            <div class="card mt-4">
                <div class="card-body text-center">
                    <h5>Ваши совпадения</h5>
                    <div class="display-4 text-primary">{{ matches_count }}</div>
                    <a href="{% url 'matches:matches_list' %}" class="btn btn-outline-primary btn-sm mt-2">
                        Посмотреть
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Правая колонка - лента пользователей -->
        <div class="col-lg-9">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Лента разработчиков</h2>
                <div class="badge bg-primary p-2">
                    Показано: {{ users|length }} пользователей
                </div>
            </div>
            
            {% if users %}
                <!-- Карточка текущего пользователя -->
                <div class="card mb-4 user-card" id="current-user-card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-3 text-center">
                                {% if users.0.user.avatar %}
                                    <img src="{{ users.0.user.avatar.url }}" 
                                         class="rounded-circle mb-3" width="120" height="120">
                                {% else %}
                                    <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" 
                                         style="width: 120px; height: 120px;">
                                        <i class="bi bi-person" style="font-size: 50px; color: #6c757d;"></i>
                                    </div>
                                {% endif %}
                                
                                <div class="compatibility-badge">
                                    <span class="badge {% if users.0.compatibility_score > 70 %}bg-success{% elif users.0.compatibility_score > 40 %}bg-warning{% else %}bg-secondary{% endif %}">
                                        Совместимость: {{ users.0.compatibility_score }}%
                                    </span>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h4>{{ users.0.user.get_full_name|default:users.0.user.username }}</h4>
                                
                                <div class="mb-3">
                                    {% if users.0.user.role %}
                                        <span class="badge bg-primary">{{ users.0.user.get_role_display }}</span>
                                    {% endif %}
                                    {% if users.0.user.level %}
                                        <span class="badge bg-info">{{ users.0.user.get_level_display }}</span>
                                    {% endif %}
                                    {% if users.0.user.work_mode %}
                                        <span class="badge bg-secondary">{{ users.0.user.get_work_mode_display }}</span>
                                    {% endif %}
                                </div>
                                
                                {% if users.0.user.city %}
                                    <p><i class="bi bi-geo-alt"></i> {{ users.0.user.city }}</p>
                                {% endif %}
                                
                                {% if users.0.user.experience_years > 0 %}
                                    <p><i class="bi bi-briefcase"></i> {{ users.0.user.experience_years }} лет опыта</p>
                                {% endif %}
                                
                                {% if users.0.user.bio %}
                                    <p class="text-muted">{{ users.0.user.bio|truncatechars:150 }}</p>
                                {% endif %}
                            </div>
                            
                            <div class="col-md-3">
                                <!-- Технологии -->
                                <h6>Технологии:</h6>
                                <div class="mb-3">
                                    {% for tech in users.0.tech_list %}
                                        <span class="badge bg-light text-dark border mb-1">{{ tech }}</span>
                                    {% endfor %}
                                    {% if users.0.user.technologies and users.0.tech_list|length == 5 %}
                                        <span class="badge bg-light text-dark border">...</span>
                                    {% endif %}
                                </div>
                                
                                <!-- Кнопки действий -->
                                <div class="action-buttons">
                                    <button class="btn btn-danger btn-lg dislike-btn" 
                                            onclick="sendDislike({{ users.0.user.id }})">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                    <button class="btn btn-success btn-lg like-btn" 
                                            onclick="sendLike({{ users.0.user.id }})">
                                        <i class="bi bi-heart"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Следующие пользователи (превью) -->
                <div class="row">
                    {% for user_data in users|slice:"1:7" %}
                    <div class="col-md-4 mb-4">
                        <div class="card h-100 user-preview-card">
                            <div class="card-body">
                                <div class="text-center mb-3">
                                    {% if user_data.user.avatar %}
                                        <img src="{{ user_data.user.avatar.url }}" 
                                             class="rounded-circle mb-2" width="80" height="80">
                                    {% else %}
                                        <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-2" 
                                             style="width: 80px; height: 80px;">
                                            <i class="bi bi-person" style="font-size: 30px; color: #6c757d;"></i>
                                        </div>
                                    {% endif %}
                                    
                                    <div class="small">
                                        <span class="badge {% if user_data.compatibility_score > 70 %}bg-success{% elif user_data.compatibility_score > 40 %}bg-warning{% else %}bg-secondary{% endif %}">
                                            {{ user_data.compatibility_score }}%
                                        </span>
                                    </div>
                                </div>
                                
                                <h6 class="text-center">{{ user_data.user.username }}</h6>
                                
                                <div class="text-center mb-2">
                                    {% if user_data.user.role %}
                                        <span class="badge bg-primary small">{{ user_data.user.get_role_display|slice:":10" }}</span>
                                    {% endif %}
                                </div>
                                
                                {% if user_data.user.city %}
                                    <p class="text-center small text-muted">
                                        <i class="bi bi-geo-alt"></i> {{ user_data.user.city }}
                                    </p>
                                {% endif %}
                                
                                <div class="text-center">
                                    {% for tech in user_data.tech_list|slice:":3" %}
                                        <span class="badge bg-light text-dark border small mb-1">{{ tech }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Пагинация/загрузка -->
                <div class="text-center mt-4">
                    <button class="btn btn-outline-primary" onclick="loadMoreUsers()">
                        <i class="bi bi-arrow-clockwise"></i> Показать еще
                    </button>
                </div>
                
            {% else %}
                <!-- Нет пользователей -->
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-people display-1 text-muted mb-3"></i>
                        <h4>Пользователи не найдены</h4>
                        <p class="text-muted">Попробуйте изменить фильтры или зайдите позже</p>
                        <a href="{% url 'matches:feed' %}" class="btn btn-primary">
                            Сбросить фильтры
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Модальное окно для мэтча -->
<div class="modal fade" id="matchModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <div class="match-hearts mb-3">
                    <i class="bi bi-heart-fill text-danger" style="font-size: 3rem;"></i>
                    <i class="bi bi-heart-fill text-danger" style="font-size: 4rem;"></i>
                    <i class="bi bi-heart-fill text-danger" style="font-size: 3rem;"></i>
                </div>
                <h3 class="mb-3">Это взаимная симпатия!</h3>
                <p class="mb-4">Вы понравились друг другу. Теперь вы можете общаться!</p>
                <div class="d-flex gap-3 justify-content-center">
                    <button class="btn btn-primary" onclick="goToMatches()">
                        <i class="bi bi-chat-dots"></i> Перейти к совпадениям
                    </button>
                    <button class="btn btn-outline-primary" data-bs-dismiss="modal">
                        Продолжить просмотр
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .user-card {
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        transition: transform 0.2s;
    }
    
    .user-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .user-preview-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .user-preview-card:hover {
        border-color: #667eea;
        transform: translateY(-3px);
    }
    
    .action-buttons {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
    }
    
    .like-btn, .dislike-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        border: none;
        transition: transform 0.2s;
    }
    
    .like-btn:hover {
        transform: scale(1.1);
        background-color: #198754 !important;
    }
    
    .dislike-btn:hover {
        transform: scale(1.1);
        background-color: #dc3545 !important;
    }
    
    .compatibility-badge {
        margin-top: 10px;
    }
    
    .match-hearts i {
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
</style>

<script>
    // Функция для получения CSRF токена
    function getCSRFToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Отправка лайка
    function sendLike(userId) {
        console.log('Sending like to user:', userId);

        const csrfToken = getCSRFToken();

        fetch(`/matches/like/${userId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({}),
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json().then(data => ({status: response.status, data}));
        })
        .then(result => {
            console.log('Response data:', result);

            if (result.status === 200) {
                // Анимация лайка
                const likeBtn = document.querySelector('.like-btn');
                likeBtn.innerHTML = '<i class="bi bi-heart-fill"></i>';
                likeBtn.classList.add('disabled');

                // Проверяем на мэтч
                if (result.data.has_match) {
                    console.log('Match found!');
                    setTimeout(() => {
                        const matchModal = new bootstrap.Modal(document.getElementById('matchModal'));
                        matchModal.show();
                    }, 500);
                }

                // Загружаем следующего пользователя через 1 секунду
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                alert(result.data.error || 'Произошла ошибка');
                console.error('Error response:', result.data);
            }
        })
        .catch(error => {
            console.error('Network error:', error);
            alert('Произошла ошибка при отправке лайка');
        });
    }

    // Отправка дизлайка
    function sendDislike(userId) {
        console.log('Sending dislike to user:', userId);

        const csrfToken = getCSRFToken();

        fetch(`/matches/dislike/${userId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({}),
        })
        .then(response => {
            console.log('Dislike response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Dislike response data:', data);

            if (data.success) {
                // Анимация дизлайка
                const dislikeBtn = document.querySelector('.dislike-btn');
                dislikeBtn.innerHTML = '<i class="bi bi-check-lg"></i>';
                dislikeBtn.classList.add('disabled');

                // Загружаем следующего пользователя через 0.5 секунды
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            } else {
                alert(data.error || 'Произошла ошибка');
            }
        })
        .catch(error => {
            console.error('Network error:', error);
            alert('Произошла ошибка при отправке дизлайка');
        });
    }
</script>
{% endblock %}